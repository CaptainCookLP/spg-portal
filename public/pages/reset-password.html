<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Passwort zurücksetzen - Mitgliederportal</title>
  
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="/icon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="/styles.css">
  
  <meta name="theme-color" content="#b91c1c">
  <meta name="description" content="Mitgliederportal für SPG Verein">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Portal">
</head>
<body style="display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px">
  <div style="width:100%;max-width:400px">
    <div class="card">
      <div class="hd">
        <h1>Passwort zurücksetzen</h1>
      </div>
      <div class="bd">
        <div id="viewForm">
          <p class="muted">Geben Sie ein neues Passwort ein</p>
          
          <div class="field">
            <label>Neues Passwort</label>
            <input id="newPassword" type="password" />
          </div>
          
          <div class="field">
            <label>Passwort wiederholen</label>
            <input id="confirmPassword" type="password" />
          </div>
          
          <button class="btn primary btn-block" id="btnReset">Passwort setzen</button>
          
          <p id="resetError" class="error" style="margin-top:15px"></p>
        </div>
        
        <div id="viewSuccess" style="display:none;text-align:center">
          <p class="success" style="font-size:18px;margin-bottom:20px">✓ Passwort erfolgreich gespeichert</p>
          <a href="/" class="btn primary btn-block">Zur Anmeldung</a>
        </div>
        
        <div id="viewError" style="display:none;text-align:center">
          <p class="error" style="font-size:18px;margin-bottom:20px">⚠ Link ungültig oder abgelaufen</p>
          <a href="/" class="btn btn-block">Zur Anmeldung</a>
        </div>
      </div>
    </div>
  </div>

  <script src="/shared/utils.js"></script>
  <script src="/shared/api.js"></script>
  <script>
    /**
     * Reset Password Page Logic
     * Standalone page for password reset via email link
     */

    const token = new URLSearchParams(window.location.search).get("token");
    const $el = {
      form: $("viewForm"),
      success: $("viewSuccess"),
      error: $("viewError"),
      newPassword: $("newPassword"),
      confirmPassword: $("confirmPassword"),
      resetBtn: $("btnReset"),
      resetError: $("resetError")
    };

    // Initialize
    document.addEventListener("DOMContentLoaded", async () => {
      if (!token) {
        showError();
        return;
      }

      // Validate token
      try {
        await api(`/api/auth/password/reset/${token}`, { method: "GET" });
        $el.resetBtn.addEventListener("click", resetPassword);
        
        // Allow Enter key
        [$el.newPassword, $el.confirmPassword].forEach(input => {
          input.addEventListener("keypress", (e) => {
            if (e.key === "Enter") resetPassword();
          });
        });
      } catch (error) {
        showError();
      }
    });

    async function resetPassword() {
      try {
        $el.resetError.textContent = "";
        
        const pwd = $el.newPassword.value.trim();
        const confirm = $el.confirmPassword.value.trim();

        if (!pwd) {
          throw new Error("Passwort erforderlich");
        }

        if (pwd.length < 8) {
          throw new Error("Passwort muss mindestens 8 Zeichen lang sein");
        }

        if (pwd !== confirm) {
          throw new Error("Passwörter stimmen nicht überein");
        }

        $el.resetBtn.disabled = true;

        await api(`/api/auth/password/reset/${token}`, {
          method: "POST",
          body: { password: pwd }
        });

        // Success
        $el.form.style.display = "none";
        $el.success.style.display = "block";
      } catch (error) {
        $el.resetError.textContent = error.message || "Fehler beim Zurücksetzen";
      } finally {
        $el.resetBtn.disabled = false;
      }
    }

    function showError() {
      $el.form.style.display = "none";
      $el.error.style.display = "block";
    }
  </script>
</body>
</html>
